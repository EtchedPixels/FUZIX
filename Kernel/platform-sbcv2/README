N8VEM SBCv2

This port is intended as a reference port for simple systems.

The N8VEM mark 2 is a single board hobby Z80 based computer. It has 512K of
RAM and 512K or 1MB of Flash. The upper 32K of the address space is fixed as
the top 32K of the 512K RAM. The lower 32K can be switched to any 32K bank
of the ROM or RAM.

Onboard I/O is limited to a 16550A UART providing a serial port and some
modem control lines, and an 8255 PIO that is normally used to connect a
PPIDE adapter. A bitbanged DS1302 real time clock is also provided but no timer
interrupt.

The only interrupt available is either from the optional ECB backplane and add
in cards, or from the 16550A, but not both.

The onboard firmware (ROMWBW) provides a monitor, BIOS and also CP/M or
ZSystem. For simplicity Fuzix is currently booted from the OS.

Supported Hardware

N8VEM SBC v2
Optional PPIDE adapter for IDE disks or CF cards
Optional ECB PropIOv2 for keyboard/VGA console/SD card interface

(currently the PropIOv2 is required - this will get fixed soon)


Implementation

This platform uses the standard banked memory model. One lower 32K bank is
assigned to the kernel (Bank 14). The upper memory is fixed at bank 15, and
bank 0-13 are available to applications, one per bank.

During execution the current per process data and stack (udata) live in the
upper bank near the top of memory. When a process is switched out they are saved
into the top of the low 32K space.

Memory Layout

Kernel
0000-00FF	Interrupt vectors
0100-7FFF	Kernel code

User
0000-00FF	Interrupt vectors
0100-7DFF	User process	(currently 7CFF needs fixing)
7E00-7FFF	Copy of task kernel stack and variables

8000-????	Kernel
????-EFFF	Disk buffers
F000-FDFF	Kernel common area and stacks
FE00-FFFF	Reserved for firmware


Notes

There are a variety of clever things that could be done to make this platform
more useful but at a cost. Firstly there is a lot of space free in the top 32K
so 8000-AFFF could probably be made user space and copied in and out each task
switch. As a single user machine doesn't switch much the cost isn't too high
and more becomes possible.

As this is meant to be a porting reference nothing clever is done. There is
no fast bank to bank copier, and no clever user to kernel copier. These can be
taken from other ports if wanted.

Oddities

The SBCv2 by default has no timer interrupt. This means that time based
pre-emption cannot be performed, and the terminal will only be responsive when
the system is waiting for user activity (except the UART if it has interrupts
enabled).

The code supports connecting a 10Hz clock source to a serial control line to
provide a real clock, and also routing the ECB interrupt using the same hack.

Some ECB cards can provide a timer interrupt. These are not presently supported.

Working With The Simulator

The way I work is as follows

Install cpmtools.
Add the following to the /usr/share/cpmtools/diskdefs

diskdef romwbwhd
  seclen 128
  tracks 1040
  sectrk 64
  blocksize 4096
  maxdir 512
  skew  0
  boottrk 16
  os 2.2
end

You can then create an sdcard image with

dd if=/dev/zero of=sdcard.img bs=512 couunt=16384

Run the simulator and in CP/M or ZSystem and (if G is the SD card drive letter)

n8vem2 -p

G:ERA *.*

then exit the simulator

Once this is done you can copy Fuzix images to it using

cpmcp -T raw -f romwbwhd sdcard.img fuzix.bin 0:fuzix.com

Then go back in the simulator and run FUZIX as a CP/M binary

